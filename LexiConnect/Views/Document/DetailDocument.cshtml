@model LexiConnect.Models.ViewModels.DetailDocumentViewModel
@{
    ViewData["Title"] = "Document Detail";
}

<link href="~/css/Document//DetailDocument.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />

<div class="page-wrapper">

    <!-- Sidebar trái -->
    <div class="sidebar">
        <h3>@Model.Document.Title</h3>
        <p>@Model.ViewerDisplayMessage</p>

        <div style="margin-top:20px;">
            <p><strong>Course:</strong> @Model.Document.Course?.CourseName</p>
            <p><strong>University:</strong> @Model.UploaderStats.UniversityName</p>
            <p><strong>Academic year:</strong> 2022/2023</p>
        </div>

        <div style="margin-top:20px;">
            <p><strong>Uploaded by:</strong></p>
            <a asp-controller="Profile"
               asp-action="PublicUserProfile"
               asp-route-id="@Model.UploaderStats.UploaderId"
               class="uploader-link">

                <div class="uploader">
                    <img src="@Model.UploaderStats.AvatarUrl" alt="avatar" />
                    <div>
                        <div class="uploader-name">@Model.UploaderStats.FullName</div>
                        <div class="uploader-university">@Model.UploaderStats.UniversityName</div>
                    </div>
                </div>

            </a>
            <!-- Thêm thống kê uploader -->
            <div class="uploader-stats">
                <div>
                    <i class="fa-solid fa-user-group"></i>
                    <span>@Model.UploaderStats.FollowerCount</span>
                </div>
                <div>
                    <i class="fa-solid fa-file-lines"></i>
                    <span>@Model.UploaderStats.UploadCount</span>
                </div>
                <div>
                    <i class="fa-solid fa-heart"></i>
                    <span>@Model.UploaderStats.LikeCount</span>
                </div>
            </div>
        </div>

        <div style="margin-top:20px; font-size:14px; color:#444;">
            <p><strong>Views:</strong> @Model.Document.ViewCount</p>
            @* <p><strong>Likes:</strong> @Model.Document.LikeCount</p> *@
            <p><strong>Can Download:</strong> @(Model.CanDownload ? "Yes" : "No")</p>
        </div>

        <button class="btn-download">Download</button>

        <!-- Add Bootstrap Icons if not already included -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    </div>

    <!-- Preview phải -->
    <div class="preview-wrapper">
        <h3>Document Preview</h3>

        <!-- Thanh action bar -->
        <div class="doc-action-bar">
            <button class="btn-download"
                    onclick="location.href='@Url.Action("Download", "Document", new { id = Model.Document.DocumentId })'">
                Download
            </button>
            <button class="btn-outline"
                             data-bs-toggle="modal"
                             data-bs-target="#aiToolsModal"
                             data-document-id="@Model.Document.DocumentId">
                <i class="fa fa-magic"></i> AI Tools
            </button>
            <button class="btn-outline"><i class="fa fa-thumbs-up" style="color:green;"></i>  <span>@Model.Document.LikeCount</span> </button>
            <button class="btn-outline"><i class="fa fa-thumbs-down" style="color:red;"></i> 0</button>
            <button class="btn-outline"><i class="fa fa-bookmark"></i> Save</button>

            <!-- Nút Favorite -->
            <button class="btn-outline btn-favorite @(Model.IsFavorited ? "active" : "")"
                    id="favoriteBtn"
                    data-document-id="@Model.Document.DocumentId">
                <i class="fa-heart @(Model.IsFavorited ? "fa-solid" : "fa-regular")" id="favoriteIcon"></i>
                <span id="favoriteText">@(Model.IsFavorited ? "Favorited" : "Favorite")</span>
            </button>

            <button class="btn-outline"><i class="fa fa-share"></i></button>
        </div>

        <!-- PDF Preview -->
        <div id="pdf-container" class="doc-preview"></div>
    </div>
</div>

<!-- AI Tools Modal -->
<div class="modal fade" id="aiToolsModal" tabindex="-1" aria-labelledby="aiToolsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <div class="d-flex align-items-center">
                    <i class="bi bi-robot fs-4 me-3"></i>
                    <div>
                        <h5 class="modal-title mb-0" id="aiToolsModalLabel">AI Document Analysis</h5>
                        <small>Ask questions about: @Model.Document.Title</small>
                    </div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Chat Container -->
                <div id="ai-chat-container" class="p-4" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                    <!-- Welcome Message -->
                    <div class="message ai-message mb-3">
                        <div class="d-flex align-items-start">
                            <div class="avatar bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                <p class="mb-0">Hello! I've loaded the document "<strong>@Model.Document.Title</strong>". I can help you with:</p>
                                <ul class="mb-0 mt-2">
                                    <li>Summarizing the document</li>
                                    <li>Answering questions about its content</li>
                                    <li>Explaining difficult concepts</li>
                                    <li>Finding specific information</li>
                                </ul>
                                <p class="mb-0 mt-2">What would you like to know?</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-top p-3 bg-white">
                    <div class="input-group">
                        <input type="text"
                               id="ai-question-input"
                               class="form-control"
                               placeholder="Ask about this document..."
                               autocomplete="off">
                        <button class="btn btn-secondary" type="button" id="ai-send-btn">
                            <i class="bi bi-send-fill"></i> Ask
                        </button>
                    </div>
                    <div class="mt-2">
                        <small class="text-muted">
                            <i class="bi bi-lightbulb"></i> Quick prompts:
                        </small>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            <button class="btn btn-outline-secondary btn-sm ai-quick-prompt" data-prompt="Summarize this document">
                                📄 Summarize
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ai-quick-prompt" data-prompt="What are the main topics covered?">
                                📚 Main Topics
                            </button>
                            <button class="btn btn-outline-secondary btn-sm ai-quick-prompt" data-prompt="Explain the key concepts">
                                💡 Key Concepts
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add these styles if not already present -->
<style>
    .ai-message .message-content {
        background-color: white;
    }

    .user-message .message-content {
        background-color: #6c757d !important;
        color: white;
    }

    .typing-indicator {
        display: inline-block;
    }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

            .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

    @@keyframes typing {
        0%, 60%, 100%

    {
        transform: translateY(0);
    }

    30% {
        transform: translateY(-10px);
    }

    }

    #ai-chat-container {
        scroll-behavior: smooth;
    }

    .message {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from

    {
        opacity: 0;
        transform: translateY(10px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }
</style>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    @if (TempData["Error"] != null)
    {
        <script>
            Swal.fire({
                icon: 'warning',
                title: 'Oops!',
                text: '@TempData["Error"]',
                confirmButtonText: 'OK'
            });
        </script>
    }
}



<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>

<script>
    // Truyền các URL từ server xuống JS
    window.pdfFileUrl = '@Url.Content(Model.FileUrl)';
    window.toggleFavoriteUrl = '@Url.Action("ToggleFavorite", "Document")';
    window.isPremiumOnly = @Model.IsPremiumOnly.ToString().ToLower(); // Thêm dòng này

</script>

<script src="~/js/Document/DetailDocument.js"></script>