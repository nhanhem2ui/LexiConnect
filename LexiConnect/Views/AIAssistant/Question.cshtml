@{
    ViewData["Title"] = "Ask Questions";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Usage Stats Card -->
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-body py-2">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <small class="text-muted">AI Usage This Month:</small>
                            <strong id="usage-display" class="ms-2">Loading...</strong>
                        </div>
                        <a href="#" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#generateQuizModal">
                            <i class="bi bi-magic"></i> Generate Quiz
                        </a>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg border-0">
                <div class="card-header bg-secondary text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-robot fs-3 me-3"></i>
                            <div>
                                <h4 class="mb-0">LexiConnect AI Assistant</h4>
                                <small>Ask me about studies, documents, or support</small>
                            </div>
                        </div>
                        <button class="btn btn-light btn-sm" id="clear-chat">
                            <i class="bi bi-trash"></i> Clear
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Container -->
                    <div id="chat-container" class="p-4" style="height: 500px; overflow-y: auto; background-color: #f8f9fa;">
                        <!-- Welcome Message -->
                        <div class="message ai-message mb-3">
                            <div class="d-flex align-items-start">
                                <div class="avatar bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                                    <i class="bi bi-robot"></i>
                                </div>
                                <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                                    <p class="mb-0">Hello! I'm your LexiConnect AI assistant. I can help you with:</p>
                                    <ul class="mb-0 mt-2">
                                        <li>Study questions and academic topics</li>
                                        <li>Finding documents and resources</li>
                                        <li>Contacting support</li>
                                        <li>Analyzing uploaded files (PDF, images, documents)</li>
                                        <li>Generating quizzes on any topic</li>
                                    </ul>
                                    <p class="mb-0 mt-2">What can I help you with today?</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="border-top p-3 bg-white">
                        <!-- File Upload Preview -->
                        <div id="file-preview" class="mb-2" style="display: none;">
                            <div class="alert alert-info d-flex align-items-center justify-content-between mb-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-paperclip me-2"></i>
                                    <span id="file-name"></span>
                                    <small class="text-muted ms-2" id="file-size"></small>
                                </div>
                                <button type="button" class="btn-close" id="remove-file"></button>
                            </div>
                        </div>

                        <!-- Hidden iframe for form submission -->
                        <iframe name="hidden-form-iframe" id="hidden-form-iframe" style="display: none;"></iframe>

                        <form id="question-form"
                              asp-action="AskWithFile"
                              asp-controller="AIAssistant"
                              method="post"
                              enctype="multipart/form-data"
                              target="hidden-form-iframe">
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" type="button" id="attach-file-btn" title="Attach file">
                                    <i class="bi bi-paperclip"></i>
                                </button>
                                <input type="file"
                                       id="file-input"
                                       name="file"
                                       class="d-none"
                                       accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.txt,.doc,.docx">
                                <input type="text"
                                       id="question-input"
                                       name="question"
                                       class="form-control"
                                       placeholder="Ask me anything..."
                                       autocomplete="off"
                                       required>
                                <button class="btn btn-secondary" type="submit" id="send-btn">
                                    <i class="bi bi-send-fill"></i> Send
                                </button>
                            </div>
                        </form>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-lightbulb"></i> Try: "How do I contact support?" or attach a document to analyze
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="mt-3">
                <h6 class="text-muted">Quick Questions:</h6>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How do I contact support?">
                        📞 Contact Support
                    </button>
                    <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How do I reset my password?">
                        🔒 Reset Password
                    </button>
                    <button class="btn btn-outline-secondary btn-sm quick-question" data-question="What study resources are available?">
                        📄 Study Resources
                    </button>
                    <button class="btn btn-outline-secondary btn-sm quick-question" data-question="About universities's documents are available at LexiConnect">
                        📚 Universities
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Generate Quiz Modal -->
<div class="modal fade" id="generateQuizModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-magic"></i> Generate Quiz with AI
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quiz-generation-form">
                    <div class="mb-3">
                        <label class="form-label">Quiz Title *</label>
                        <input type="text" class="form-control" id="quiz-title" required
                               placeholder="e.g., Introduction to Data Structures">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subject *</label>
                        <input type="text" class="form-control" id="quiz-subject" required
                               placeholder="e.g., Computer Science, Biology, History">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" id="quiz-difficulty">
                                <option value="Easy">Easy</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Hard">Hard</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" class="form-control" id="quiz-num-questions"
                                   value="5" min="3" max="20">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="quiz-description" rows="2"
                                  placeholder="Brief description of the quiz"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Additional Context (Optional)</label>
                        <textarea class="form-control" id="quiz-context" rows="3"
                                  placeholder="e.g., Focus on specific topics, chapters, or concepts..."></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="quiz-public">
                        <label class="form-check-label" for="quiz-public">
                            Make this quiz public (visible to other users)
                        </label>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Generating a quiz will use <strong>1 AI request</strong> from your monthly quota.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="generate-quiz-btn">
                    <i class="bi bi-magic"></i> Generate Quiz
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .message {
        animation: fadeIn 0.3s ease-in;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .user-message .message-content {
        background-color: #6c757d !important;
        color: white;
    }

    .ai-message .message-content {
        background-color: white;
    }

    .typing-indicator {
        display: inline-block;
    }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6c757d;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

            .typing-indicator span:nth-child(2) {
                animation-delay: 0.2s;
            }

            .typing-indicator span:nth-child(3) {
                animation-delay: 0.4s;
            }

    @@keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }

        30% {
            transform: translateY(-10px);
        }
    }

    #chat-container {
        scroll-behavior: smooth;
    }

    .file-attachment-badge {
        display: inline-block;
        background-color: #f1f3f4;
        color: #495057;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-top: 8px;
    }
</style>

@section Scripts {
    <script>
        const chatContainer = document.getElementById('chat-container');
        const questionInput = document.getElementById('question-input');
        const questionForm = document.getElementById('question-form');
        const sendBtn = document.getElementById('send-btn');
        const quickQuestions = document.querySelectorAll('.quick-question');
        const fileInput = document.getElementById('file-input');
        const attachFileBtn = document.getElementById('attach-file-btn');
        const filePreview = document.getElementById('file-preview');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const removeFileBtn = document.getElementById('remove-file');
        const clearChatBtn = document.getElementById('clear-chat');
        const hiddenIframe = document.getElementById('hidden-form-iframe');
        const usageDisplay = document.getElementById('usage-display');
        const generateQuizBtn = document.getElementById('generate-quiz-btn');

        let selectedFile = null;
        let currentTypingId = null;

        // Load usage stats on page load
        loadUsageStats();

        async function loadUsageStats() {
            try {
                const response = await fetch('@Url.Action("GetUsageStats", "AIAssistant")');
                const data = await response.json();
                updateUsageDisplay(data);
            } catch (error) {
                console.error('Error loading usage stats:', error);
                usageDisplay.textContent = 'Error loading stats';
            }
        }

        function updateUsageDisplay(data) {
            if (!data) {
                usageDisplay.textContent = 'Unavailable';
                return;
            }

            const isUnlimited = data.isUnlimited === true || data.total === null || typeof data.total === 'undefined';

            if (isUnlimited) {
                usageDisplay.innerHTML = '<span class="badge bg-success">Unlimited (Premium)</span>';
                return;
            }

            const remaining = typeof data.remaining === 'number'
                ? data.remaining
                : Math.max((data.total ?? 0) - (data.used ?? 0), 0);
            const badgeClass = remaining > 3 ? 'bg-success' : remaining > 0 ? 'bg-warning' : 'bg-danger';
            usageDisplay.innerHTML = `<span class="badge ${badgeClass}">${remaining}/${data.total} remaining</span>`;
        }

        attachFileBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    alert(`File size (${formatFileSize(file.size)}) exceeds the maximum limit of 5MB.`);
                    fileInput.value = '';
                    selectedFile = null;
                    filePreview.style.display = 'none';
                    return;
                }
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = formatFileSize(file.size);
                filePreview.style.display = 'block';
            }
        });

        removeFileBtn.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            filePreview.style.display = 'none';
        });

        function resetChatHistory() {
            const messages = chatContainer.querySelectorAll('.message');
            messages.forEach((msg, index) => {
                if (index > 0) msg.remove();
            });
        }

        clearChatBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to clear the chat history?')) {
                resetChatHistory();
            }
        });

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        questionForm.addEventListener('submit', (e) => {
            const question = questionInput.value.trim();
            if (!question) {
                e.preventDefault();
                return;
            }
            resetChatHistory();
            addMessage(question, 'user', selectedFile);
            currentTypingId = showTypingIndicator();
            const tempFile = selectedFile;
            selectedFile = null;
            filePreview.style.display = 'none';
        });

        hiddenIframe.addEventListener('load', () => {
            try {
                const iframeDoc = hiddenIframe.contentDocument || hiddenIframe.contentWindow.document;
                const responseText = iframeDoc.body.textContent;

                if (responseText) {
                    const data = JSON.parse(responseText);
                    if (currentTypingId) {
                        removeTypingIndicator(currentTypingId);
                        currentTypingId = null;
                    }

                    if (data.limitReached) {
                        addMessage(data.error + ' Consider upgrading to Premium for unlimited access.', 'ai');
                    } else if (data.error) {
                        addMessage(`Sorry, I encountered an error: ${data.error}`, 'ai');
                    } else if (data.answer) {
                        addMessage(data.answer, 'ai');
                        if (data.usageStats) {
                            updateUsageDisplay(data.usageStats);
                        }
                    }
                }
            } catch (error) {
                console.error('Error parsing response:', error);
                if (currentTypingId) {
                    removeTypingIndicator(currentTypingId);
                    currentTypingId = null;
                }
                addMessage('Sorry, I encountered an error processing the response.', 'ai');
            }
            questionInput.value = '';
            fileInput.value = '';
        });

        // Generate Quiz functionality
        generateQuizBtn.addEventListener('click', async () => {
            const title = document.getElementById('quiz-title').value.trim();
            const subject = document.getElementById('quiz-subject').value.trim();
            const difficulty = document.getElementById('quiz-difficulty').value;
            const numQuestions = parseInt(document.getElementById('quiz-num-questions').value);
            const description = document.getElementById('quiz-description').value.trim();
            const context = document.getElementById('quiz-context').value.trim();
            const isPublic = document.getElementById('quiz-public').checked;

            if (!title || !subject) {
                alert('Please fill in the required fields (Title and Subject)');
                return;
            }

            generateQuizBtn.disabled = true;
            generateQuizBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';

            try {
                const response = await fetch('@Url.Action("GenerateQuiz", "AIAssistant")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        subject,
                        difficulty,
                        numberOfQuestions: numQuestions,
                        description: description || null,
                        additionalContext: context || null,
                        isPublic
                    })
                });

                const data = await response.json();

                if (data.limitReached) {
                    alert(data.error);
                } else if (data.success) {
                    alert(`Quiz "${title}" generated successfully with ${data.questionsGenerated} questions!`);
                    bootstrap.Modal.getInstance(document.getElementById('generateQuizModal')).hide();
                    document.getElementById('quiz-generation-form').reset();

                    if (data.usageStats) {
                        updateUsageDisplay(data.usageStats);
                    }

                    // Optionally redirect to quiz view
                    // window.location.href = `/Quiz/Details/${data.quizId}`;
                } else {
                    alert('Error generating quiz: ' + data.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while generating the quiz');
            } finally {
                generateQuizBtn.disabled = false;
                generateQuizBtn.innerHTML = '<i class="bi bi-magic"></i> Generate Quiz';
            }
        });

        function addMessage(text, type, file = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message mb-3`;

            let fileAttachment = '';
            if (file && type === 'user') {
                fileAttachment = `<div class="file-attachment-badge"><i class="bi bi-paperclip"></i> ${escapeHtml(file.name)}</div>`;
            }

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start justify-content-end">
                        <div class="message-content bg-secondary text-white p-3 rounded shadow-sm" style="max-width: 80%;">
                            <p class="mb-0">${escapeHtml(text)}</p>
                            ${fileAttachment}
                        </div>
                        <div class="avatar bg-secondary text-white rounded-circle ms-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="avatar bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div class="message-content bg-white p-3 rounded shadow-sm" style="max-width: 80%;">
                            ${formatMessage(text)}
                        </div>
                    </div>
                `;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function formatMessage(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" class="text-decoration-none text-primary">$1</a>');
            formatted = formatted.replace(/\n\n/g, '</p><p class="mb-2">');
            formatted = formatted.replace(/\n/g, '<br>');
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            const lines = formatted.split('<br>');
            let inList = false;
            let result = [];
            for (let line of lines) {
                if (line.trim().match(/^[-•*]\s+/)) {
                    if (!inList) {
                        result.push('<ul class="mb-2 mt-2">');
                        inList = true;
                    }
                    result.push('<li>' + line.replace(/^[-•*]\s+/, '') + '</li>');
                } else {
                    if (inList) {
                        result.push('</ul>');
                        inList = false;
                    }
                    result.push(line);
                }
            }
            if (inList) result.push('</ul>');
            formatted = result.join('<br>');
            return `<div>${formatted}</div>`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message mb-3';
            typingDiv.id = 'typing-indicator-' + Date.now();
            typingDiv.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="avatar bg-secondary text-white rounded-circle me-3 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; min-width: 40px;">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-content bg-white p-3 rounded shadow-sm">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return typingDiv.id;
        }

        function removeTypingIndicator(id) {
            const indicator = document.getElementById(id);
            if (indicator) indicator.remove();
        }

        quickQuestions.forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.getAttribute('data-question');
                questionInput.value = question;
                questionInput.focus();
            });
        });

        questionInput.focus();
    </script>
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">